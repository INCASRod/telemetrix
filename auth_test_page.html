<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INCAS Telemetrix</title>
    <script src="https://alcdn.msauth.net/browser/2.32.2/js/msal-browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="logo">
            <img src="logo.svg" alt="INCAS Telemetrix" class="logo-image">
            <div class="logo-subtitle">Telemetrix</div>
        </div>
        
        <div class="login-card">
            <h1 class="login-title">DASHBOARD LOGIN</h1>
            
            <div id="status" class="status-message">Loading...</div>
            
            <div class="auth-buttons">
                <button id="loginBtn" onclick="login()" class="login-btn" style="display:none;">
                    Sign In with Microsoft
                </button>
                <button id="logoutBtn" onclick="logout()" class="logout-btn" style="display:none;">
                    Sign Out
                </button>
            </div>
            
            <div id="results" class="results-section"></div>
        </div>
    </div>

    <script>
        // MSAL configuration
        const msalConfig = {
            auth: {
                clientId: "758ff3e9-e6bd-4838-90d0-50cf3ec88387",
                authority: "https://login.microsoftonline.com/common",
                redirectUri: "https://incasrod.github.io/telemetrix/auth_test_page.html"
            }
        };

        const myMSALObj = new msal.PublicClientApplication(msalConfig);

        const loginRequest = {
            scopes: ["openid", "profile", "email"]
        };

        let account = null;

        // Initialize
        myMSALObj.handleRedirectPromise().then(response => {
            if (response) {
                account = response.account;
            } else {
                account = myMSALObj.getAllAccounts()[0];
            }

            // If user is already authenticated, redirect to dashboard immediately
            if (account) {
                document.getElementById('status').innerHTML = `
                    <div class="loading-message">
                        <div class="loading-icon">üîÑ</div>
                        <div class="loading-text">Already authenticated. Redirecting to dashboard...</div>
                    </div>
                `;
                
                setTimeout(() => {
                    window.location.href = "https://incasrod.github.io/telemetrix/dashboard.html";
                }, 1000);
                return;
            }

            updateUI();
        });

        function updateUI() {
            const statusDiv = document.getElementById('status');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            if (account) {
                statusDiv.innerHTML = `
                    <div class="user-info">
                        <div class="status-icon">‚úÖ</div>
                        <div class="user-details">
                            <div class="username">${account.username}</div>
                            <div class="display-name">${account.name}</div>
                        </div>
                    </div>
                `;
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
            } else {
                statusDiv.innerHTML = `
                    <div class="auth-prompt">
                        <div class="status-icon">üîê</div>
                        <div class="auth-message">Please authenticate to access the dashboard</div>
                    </div>
                `;
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
            }
        }

        async function login() {
            try {
                // Show loading state
                document.getElementById('status').innerHTML = `
                    <div class="loading-message">
                        <div class="loading-icon">üîÑ</div>
                        <div class="loading-text">Opening Microsoft login...</div>
                    </div>
                `;

                // Clear any previous errors
                document.getElementById('results').innerHTML = '';

                const response = await myMSALObj.loginPopup(loginRequest);
                account = response.account;
                
                // Show success message briefly before redirect
                document.getElementById('status').innerHTML = `
                    <div class="success-message">
                        <div class="success-icon">‚úÖ</div>
                        <div class="success-title">Login Successful! Redirecting to dashboard...</div>
                    </div>
                `;

                // Redirect immediately to dashboard
                setTimeout(() => {
                    window.location.href = "https://incasrod.github.io/telemetrix/dashboard.html";
                }, 1000);
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Handle specific error types
                if (error.errorCode === 'user_cancelled') {
                    document.getElementById('status').innerHTML = `
                        <div class="auth-prompt">
                            <div class="status-icon">üîê</div>
                            <div class="auth-message">Login was cancelled. Please try again to access the dashboard.</div>
                        </div>
                    `;
                } else {
                    document.getElementById('results').innerHTML = `
                        <div class="error-message">
                            <div class="error-icon">‚ùå</div>
                            <div class="error-text">Login error: ${error.message}</div>
                            <div class="error-details">Error Code: ${error.errorCode || 'Unknown'}</div>
                        </div>
                    `;
                    // Reset to original state
                    updateUI();
                }
            }
        }

        function logout() {
            // Use logoutPopup with postLogoutRedirectUri to stay in the app
            const logoutRequest = {
                account: account,
                postLogoutRedirectUri: window.location.href, // Stay on current page
                onRedirectNavigate: () => {
                    return false; // Prevent navigation
                }
            };
            
            try {
                myMSALObj.logoutPopup(logoutRequest);
                account = null;
                updateUI();
                document.getElementById('results').innerHTML = '';
            } catch (error) {
                console.error('Logout error:', error);
                // Force local logout if popup fails
                account = null;
                updateUI();
                document.getElementById('results').innerHTML = '';
            }
        }
    </script>
</body>
</html>
