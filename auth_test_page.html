<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INCAS Telemetrix</title>
    <script src="https://alcdn.msauth.net/browser/2.32.2/js/msal-browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="logo">
            <img src="logo.svg" alt="INCAS Telemetrix" class="logo-image">
            <div class="logo-subtitle">Telemetrix</div>
        </div>
        
        <div class="login-card">
            <h1 class="login-title">DASHBOARD LOGIN</h1>
            
            <div id="status" class="status-message">Loading...</div>
            
            <div class="auth-buttons">
                <button id="loginBtn" onclick="login()" class="login-btn" style="display:none;">
                    Sign In with Microsoft
                </button>
                <button id="logoutBtn" onclick="logout()" class="logout-btn" style="display:none;">
                    Sign Out
                </button>
                <button id="testApiBtn" onclick="testApi()" class="test-btn" style="display:none;">
                    Test API Connection
                </button>
            </div>
            
            <div id="results" class="results-section"></div>
        </div>
    </div>

    <script>
        // MSAL configuration
        const msalConfig = {
            auth: {
                clientId: "758ff3e9-e6bd-4838-90d0-50cf3ec88387",
                authority: "https://login.microsoftonline.com/common",
                redirectUri: "https://incasrod.github.io/telemetrix/auth_test_page.html"
            }
        };

        const myMSALObj = new msal.PublicClientApplication(msalConfig);

        const loginRequest = {
            scopes: ["openid", "profile", "email"]
        };

        let account = null;

        // Initialize
        myMSALObj.handleRedirectPromise().then(response => {
            if (response) {
                account = response.account;
            } else {
                account = myMSALObj.getAllAccounts()[0];
            }
            updateUI();
        });

        function updateUI() {
            const statusDiv = document.getElementById('status');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const testApiBtn = document.getElementById('testApiBtn');

            if (account) {
                statusDiv.innerHTML = `
                    <div class="user-info">
                        <div class="status-icon">‚úÖ</div>
                        <div class="user-details">
                            <div class="username">${account.username}</div>
                            <div class="display-name">${account.name}</div>
                        </div>
                    </div>
                `;
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                testApiBtn.style.display = 'inline-block';
            } else {
                statusDiv.innerHTML = `
                    <div class="auth-prompt">
                        <div class="status-icon">üîê</div>
                        <div class="auth-message">Please authenticate to access the dashboard</div>
                    </div>
                `;
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                testApiBtn.style.display = 'none';
            }
        }

        async function login() {
            try {
                const response = await myMSALObj.loginPopup(loginRequest);
                account = response.account;
                updateUI();
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('results').innerHTML = `
                    <div class="error-message">
                        <div class="error-icon">‚ùå</div>
                        <div class="error-text">Login error: ${error.message}</div>
                    </div>
                `;
            }
        }

        function logout() {
            myMSALObj.logoutPopup();
            account = null;
            updateUI();
            document.getElementById('results').innerHTML = '';
        }

        async function testApi() {
            if (!account) {
                alert('Please sign in first');
                return;
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="loading-message">
                    <div class="loading-icon">üîÑ</div>
                    <div class="loading-text">Testing API connection...</div>
                </div>
            `;

            try {
                const tokenRequest = {
                    scopes: ["openid", "profile", "email"],
                    account: account
                };

                const response = await myMSALObj.acquireTokenSilent(tokenRequest);
                const accessToken = response.accessToken;

                console.log('üîë Access token:', accessToken);

                // Test API call with better error handling
                const apiUrl = 'https://incas-functions-dev-b8djeyakc7d0hwa3.australiasoutheast-01.azurewebsites.net/api/GetCurrentStatus';
                
                try {
                    const apiResponse = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    });

                    console.log('API Response Status:', apiResponse.status);
                    console.log('API Response Status Text:', apiResponse.statusText);
                    console.log('API Response Headers:', [...apiResponse.headers.entries()]);

                    // Get response as text first to see what we actually received
                    const responseText = await apiResponse.text();
                    console.log('Raw API Response:', responseText);

                    if (!apiResponse.ok) {
                        resultsDiv.innerHTML = `
                            <div class="error-message">
                                <div class="error-icon">‚ùå</div>
                                <div class="error-title">API Request Failed</div>
                                <div class="error-details">
                                    <strong>Status:</strong> ${apiResponse.status} ${apiResponse.statusText}<br>
                                    <strong>URL:</strong> ${apiUrl}
                                </div>
                                <div class="api-response">
                                    <strong>Response:</strong>
                                    <pre>${responseText.substring(0, 1000)}${responseText.length > 1000 ? '...' : ''}</pre>
                                </div>
                            </div>
                        `;
                        return;
                    }

                    // Try to parse as JSON
                    let data;
                    if (responseText.trim()) {
                        try {
                            data = JSON.parse(responseText);
                        } catch (parseError) {
                            console.error('JSON Parse Error:', parseError);
                            resultsDiv.innerHTML = `
                                <div class="error-message">
                                    <div class="error-icon">‚ùå</div>
                                    <div class="error-title">Invalid JSON Response</div>
                                    <div class="error-details">
                                        <strong>Parse Error:</strong> ${parseError.message}<br>
                                        <strong>Response Type:</strong> ${apiResponse.headers.get('content-type')}
                                    </div>
                                    <div class="api-response">
                                        <strong>Raw Response:</strong>
                                        <pre>${responseText.substring(0, 1000)}${responseText.length > 1000 ? '...' : ''}</pre>
                                    </div>
                                </div>
                            `;
                            return;
                        }
                    } else {
                        data = { message: "Empty response" };
                    }

                    // Success!
                    resultsDiv.innerHTML = `
                        <div class="success-message">
                            <div class="success-icon">‚úÖ</div>
                            <div class="success-title">API Connection Successful!</div>
                            <div class="api-response">
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </div>
                        </div>
                    `;

                } catch (fetchError) {
                    console.error('Fetch Error:', fetchError);
                    resultsDiv.innerHTML = `
                        <div class="error-message">
                            <div class="error-icon">‚ùå</div>
                            <div class="error-title">Network/CORS Error</div>
                            <div class="error-details">
                                <strong>Error:</strong> ${fetchError.message}<br>
                                <strong>Possible causes:</strong>
                                <ul style="text-align: left; margin-top: 10px;">
                                    <li>CORS not configured for GitHub Pages origin</li>
                                    <li>API endpoint not accessible</li>
                                    <li>Network connectivity issue</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('API test error:', error);
                resultsDiv.innerHTML = `
                    <div class="error-message">
                        <div class="error-icon">‚ùå</div>
                        <div class="error-text">API test error: ${error.message}</div>
                        <div class="error-details">Check browser console for more details</div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
